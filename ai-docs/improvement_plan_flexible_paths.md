# Improvement Plan: Make Service File Paths Flexible

**Goal:** Avoid hardcoding the absolute installation path within the systemd service file and macOS plist file, making the setup less dependent on the exact directory structure (`~/Developer/faster-whisper-dictation`).

**Affected Files:**

- `setup.sh`
- `dictation.service` (Template)
- `com.user.dictation.plist` (Generated by `setup.sh`)

**Steps:**

1.  **Define Absolute Path Variable in `setup.sh`:**

    - The script already defines `SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"`. This is the absolute path we need.

2.  **Modify `dictation.service` (Template):**

    - Replace hardcoded paths with placeholders:

      ```ini
      [Unit]
      Description=Dictation Service
      # ... other lines ...

      [Service]
      Type=simple
      Environment="PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
      WorkingDirectory=@@WORKING_DIR@@
      ExecStart=/bin/bash @@EXEC_START@@
      Restart=on-failure
      RestartSec=10
      TimeoutStartSec=30

      [Install]
      WantedBy=graphical-session.target
      ```

3.  **Modify `setup.sh` (Linux Systemd Part):**

    - Before copying the service file, use `sed` to replace the placeholders with the value of `$SCRIPT_DIR`:

      ```bash
      # Inside the Linux setup section of setup.sh
      SERVICE_FILE_USER=~/.config/systemd/user/dictation.service
      RUN_SCRIPT_PATH="$SCRIPT_DIR/run.sh"

      # Create user systemd directory
      mkdir -p ~/.config/systemd/user

      log "Creating systemd service file with correct paths..."
      # Use a temporary file for sed output then move, or use sed -i if preferred
      sed -e "s|@@WORKING_DIR@@|$SCRIPT_DIR|g" \
          -e "s|@@EXEC_START@@|$RUN_SCRIPT_PATH|g" \
          dictation.service > "$SERVICE_FILE_USER"

      # Reload systemd daemon, enable, start... (as before)
      ```

4.  **Modify `setup.sh` (macOS Launchd Part):**

    - The current script uses a `cat > com.user.dictation.plist << EOF` block. This already correctly expands `${SCRIPT_DIR}` at the time `setup.sh` is run because the `EOF` marker is not quoted.
    - **Verification:** Double-check the generated `com.user.dictation.plist` file in `~/Library/LaunchAgents/` after running `setup.sh` to ensure the `<string>${SCRIPT_DIR}/run.sh</string>` and `<string>${SCRIPT_DIR}</string>` lines contain the _actual absolute path_, not the literal `${SCRIPT_DIR}`. If they contain the literal, remove quotes around the `EOF` marker in `setup.sh`. (Current script looks correct).

5.  **Modify `run.sh`:**
    - Ensure `run.sh` consistently uses `"$SCRIPT_DIR"` to find `main.py` and the virtual environment activation script. (Current script looks correct: `cd "$SCRIPT_DIR"`, `source ".venv/bin/activate"`, `python "$SCRIPT_DIR/main.py"`).

**Rationale:** This decouples the service configuration from a specific hardcoded user directory structure. The setup script now dynamically inserts the correct absolute path based on where the user cloned/placed the repository, making the installation more portable.
